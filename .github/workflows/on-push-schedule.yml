name: On push Scheduled Feature Branch Check

on:
  schedule:
    - cron: "10 9 * * *" 
  workflow_dispatch:

jobs:
  check-commits:
    runs-on: self-hosted
    outputs:
      has_changes: ${{ steps.check.outputs.has_changes }}
      latest_commit: ${{ steps.check.outputs.latest_commit }}
      latest_branch: ${{ steps.check.outputs.latest_branch }}
    steps:
      - name: Checkout repository (Fetch all history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ensure full commit history

      - name: Fetch latest changes
        run: git fetch --all

      - name: Check for new commits on feature branches
        id: check
        run: |
          latest_commit=$(git log --remotes --branches="feature-*" --pretty=format:'%H' -n 1)
          latest_branch=$(git branch -r --contains $latest_commit | grep "feature-" | head -n 1 | sed 's/origin\///')

          echo "Latest Commit ID: $latest_commit"
          echo "Branch: $latest_branch"

          last_run_file="$GITHUB_WORKSPACE/.last_run_commit"
          
          if [ -f "$last_run_file" ]; then
            last_commit=$(cat "$last_run_file")
          else
            last_commit=""
          fi
          
          if [ "$latest_commit" != "$last_commit" ] && [ -n "$latest_commit" ]; then
            echo "::set-output name=has_changes::true"
            echo "::set-output name=latest_commit::$latest_commit"
            echo "::set-output name=latest_branch::$latest_branch"
            echo "$latest_commit" > "$last_run_file"
          else
            echo "::set-output name=has_changes::false"
          fi

  run-task:
    needs: check-commits
    if: needs.check-commits.outputs.has_changes == 'true'  # Ensures this runs only when changes are detected
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Display detected commit and branch
        run: |
          echo "Triggered by commit: ${{ needs.check-commits.outputs.latest_commit }}"
          echo "On branch: ${{ needs.check-commits.outputs.latest_branch }}"

      - name: Display test.txt contents
        run: cat check.txt
