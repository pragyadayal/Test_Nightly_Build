name: On Push Scheduled Branch Check

on:
  schedule:
    - cron: "30 7 * * *"  
  workflow_dispatch:  # Allows manual triggering

jobs:
  check-new-commits:
    runs-on: ubuntu-latest
    outputs:
      changed_feature_branches: ${{ steps.detect-changes.outputs.changed_feature_branches }}
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full commit history for accurate comparison

      - name: Detect new commits on all branches
        id: detect-changes
        run: |
          # Fetch all branches
          git fetch --all
          ALL_BRANCHES=$(git branch -r | grep -oE 'origin/[^ ]+' | sed 's/origin\///')
          CHANGED_FEATURE_BRANCHES=()

           echo "Checking for new commits..."
          for branch in $ALL_BRANCHES; do
            latest_commit=$(git rev-parse origin/$branch)  # Get latest commit of remote branch
          
            # Find last build commit using the previous commit on this specific branch
            last_build_commit=$(git rev-list --max-parents=0 origin/$branch 2>/dev/null)
          
            if [ "$latest_commit" != "$last_build_commit" ]; then
              echo "✅ New commits detected on $branch: $latest_commit"
              if [[ "$branch" == feature-* ]]; then
                CHANGED_FEATURE_BRANCHES+=("\"$branch\"")
              fi
            else
              echo "❌ No new commits on $branch"
            fi
          done

          echo "Changed feature branches: ${CHANGED_FEATURE_BRANCHES[*]}"
          CHANGED_BRANCHES_JSON="[$(IFS=,; echo "${CHANGED_FEATURE_BRANCHES[*]}")]"
          echo "::set-output name=changed_feature_branches::$CHANGED_BRANCHES_JSON"
                    
  build-feature-branches:
    needs: check-new-commits
    if: needs.check-new-commits.outputs.changed_feature_branches != '[]'
    strategy:
      matrix:
        branch: ${{ fromJson(needs.check-new-commits.outputs.changed_feature_branches) }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ${{ matrix.branch }}
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}

      - name: Display check.txt content
        run: cat check.txt
           
